/******************************************************************************
** ECE486/586 PDP-8 Simulator
** Sean Koppenhafer, Luis Santiago, Ken Benderly, J.S. Peirce
**
** cpu.c
*/

#include "cpu.h"

/******************************************************************************
** OPCODE 0 - AND
******************************************************************************/
void AND(void) {
	AC &= MB;
}

/******************************************************************************
** OPCODE 1 - TAD
******************************************************************************/
void TAD(void) {
	/* TODO: 12 bit addition */
}

/******************************************************************************
** OPCODE 2 - ISZ
******************************************************************************/
void ISZ(void) {
	/* If MB is zero, do nothing */
	if(MB) {
		MB = (MB + 1) & CUTOFF_MASK;
	}
}

/******************************************************************************
** OPCODE 3 - DCA
******************************************************************************/
void DCA(void) {
	MB = AC;
	AC = 0;
}

/******************************************************************************
** OPCODE 4 - JMS
******************************************************************************/
void JMS(void) {
	MB = PC;
	/* TODO: write MB to memory */
	PC = (CPMA + 1) & CUTOFF_MASK;
}

/******************************************************************************
** OPCODE 5 - JMP
******************************************************************************/
void JMP(void) {
	PC = CPMA;
}

/******************************************************************************
** OPCODE 7 GROUP 1 - CLA
******************************************************************************/
void CLA(void) {
	AC = 0;
}

/******************************************************************************
** OPCODE 7 GROUP 1 - CLL
******************************************************************************/
void CLL(void) {
	link_bit = 0;
}

/******************************************************************************
** OPCODE 7 GROUP 1 - CMA
******************************************************************************/
void CMA(void) {
	AC = ~AC & CUTOFF_MASK;
}

/******************************************************************************
** OPCODE 7 GROUP 1 - CML
******************************************************************************/
void CML(void) {
	link_bit = ~link_bit & 1;
}

/******************************************************************************
** OPCODE 7 GROUP 1 - IAC
******************************************************************************/
void IAC(void) {
	AC = (AC + 1) & CUTOFF_MASK;
}

/******************************************************************************
** OPCODE 7 GROUP 1 - RAR
******************************************************************************/
void RAR(void) {
	const uint8_t = bit11_shift = 12;
	uint8_t old_link = link_bit;

	/* Shift right 1.  New link is bit 0 of AC before shift.
	** Bit 11 of new AC is old link bit value.
	*/
	link_bit = AC & 1;
	AC >>= 1;
	AC = (AC | (old_link << bit11_shift)) & CUTOFF_MASK;
}

/******************************************************************************
** OPCODE 7 GROUP 1 - RTR
******************************************************************************/
void RTR(void) {
	/* Same as two RAR in a row */
	RAR();
	RAR();
}

/******************************************************************************
** OPCODE 7 GROUP 1 - RAL
******************************************************************************/
void RAL(void) {
	const uint8_t shift_num = 12;	/* Shift bit 12 into bit 0 */
	const uint16_t new_link_pos = 0x1000;	/* Bit 12 */

	/* Shift AC left 1.  New link is bit 12
	** New bit 0 of AC is old link
	*/
	AC <<= 1;
	AC |= link_bit;
	link_bit = (AC & new_link_pos) >> shift_num;
}

/******************************************************************************
** OPCODE 7 GROUP 1 - RTL
******************************************************************************/
void RTL(void) {
	/* Same as two RAL in a row */
	RAL();
	RAL();
}

